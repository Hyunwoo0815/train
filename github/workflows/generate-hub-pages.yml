# .github/workflows/generate-hub-pages.yml
name: ğŸš„ í—ˆë¸Œ í˜ì´ì§€ ìƒì„± ë° ë°°í¬

on:
  # í‘¸ì‹œí•  ë•Œë§ˆë‹¤ ì‹¤í–‰ (main ë¸Œëœì¹˜)
  push:
    branches: [ main ]
    paths:
      - 'cache/**'
      - 'hub.py'
      - '.github/workflows/**'
  
  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:
    inputs:
      target_station:
        description: 'íŠ¹ì • ì—­ë§Œ ì²˜ë¦¬ (ì„ íƒì‚¬í•­)'
        required: false
        default: ''
      use_html_extension:
        description: 'HTML í™•ì¥ì ì‚¬ìš©'
        required: false
        default: 'false'
        type: choice
        options:
        - 'true'
        - 'false'

jobs:
  generate-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: ğŸ Python í™˜ê²½ ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        pip install --upgrade pip
        # í•„ìš”í•œ íŒ¨í‚¤ì§€ê°€ ìˆë‹¤ë©´ ì—¬ê¸°ì— ì¶”ê°€
        # pip install requests beautifulsoup4
    
    - name: ğŸ“Š ì…ë ¥ ë°ì´í„° í™•ì¸
      run: |
        echo "ğŸ” cache í´ë” ë‚´ìš© í™•ì¸:"
        if [ -d "cache" ]; then
          echo "ğŸ“‚ cache í´ë” ì¡´ì¬í•¨"
          echo "ğŸ“„ JSON íŒŒì¼ ê°œìˆ˜: $(ls cache/*.json 2>/dev/null | wc -l)"
          echo "ğŸ“‹ íŒŒì¼ ëª©ë¡ (ì²˜ìŒ 10ê°œ):"
          ls cache/*.json 2>/dev/null | head -10 || echo "JSON íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤"
        else
          echo "âŒ cache í´ë”ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤"
          exit 1
        fi
    
    - name: ğŸ—‘ï¸ ê¸°ì¡´ HTML íŒŒì¼ë“¤ ì •ë¦¬ (ê°•ì œ ë®ì–´ì“°ê¸°)
      run: |
        echo "ğŸ§¹ ê¸°ì¡´ HTML íŒŒì¼ë“¤ ì •ë¦¬ ì¤‘..."
        
        # ê¸°ì¡´ HTML íŒŒì¼ í˜„í™© í™•ì¸
        html_count=$(find . -maxdepth 1 -name "*.html" -o -name "*ì—´ì°¨ì‹œê°„í‘œ" | wc -l)
        if [ $html_count -gt 0 ]; then
          echo "ğŸ“Š ê¸°ì¡´ HTML íŒŒì¼: ${html_count}ê°œ"
          echo "ğŸ“‹ íŒŒì¼ ëª©ë¡:"
          find . -maxdepth 1 -name "*.html" -o -name "*ì—´ì°¨ì‹œê°„í‘œ" | head -5
        fi
        
        # meta.json ë°±ì—… (ë°œí–‰ì¼ ìœ ì§€ë¥¼ ìœ„í•´)
        if [ -f "meta.json" ]; then
          echo "ğŸ’¾ meta.json ë°±ì—… ì¤‘..."
          cp meta.json meta.json.backup
        fi
        
        # ê¸°ì¡´ HTML íŒŒì¼ë“¤ ì‚­ì œ (ë£¨íŠ¸ í´ë”ì˜ HTMLë§Œ)
        echo "ğŸ—‘ï¸ ê¸°ì¡´ HTML íŒŒì¼ë“¤ ì‚­ì œ..."
        find . -maxdepth 1 -name "*.html" -delete 2>/dev/null || true
        find . -maxdepth 1 -name "*ì—´ì°¨ì‹œê°„í‘œ" -delete 2>/dev/null || true
        rm -f meta.json
        
        # meta.json ë³µì› (ë°œí–‰ì¼ ìœ ì§€)
        if [ -f "meta.json.backup" ]; then
          echo "ğŸ“‹ meta.json ë³µì›..."
          mv meta.json.backup meta.json
        fi
        
        echo "âœ… HTML íŒŒì¼ ì •ë¦¬ ì™„ë£Œ"
    
    - name: ğŸš„ í—ˆë¸Œ í˜ì´ì§€ ìƒì„±
      env:
        INPUT_FOLDER: cache
        OUTPUT_FOLDER: .
        SITE_BASE_URL: ${{ github.event.repository.name != github.repository_owner.login && format('https://{0}.github.io/{1}', github.repository_owner, github.event.repository.name) || format('https://{0}.github.io', github.repository_owner) }}
        USE_HTML_EXTENSION: ${{ github.event.inputs.use_html_extension || 'false' }}
        TARGET_STATION: ${{ github.event.inputs.target_station }}
      run: |
        echo "ğŸš€ í—ˆë¸Œ í˜ì´ì§€ ìƒì„± ì‹œì‘"
        echo "ğŸ“‚ ì…ë ¥ í´ë”: $INPUT_FOLDER"
        echo "ğŸ“ ì¶œë ¥ í´ë”: $OUTPUT_FOLDER (ë£¨íŠ¸ í´ë”)"
        echo "ğŸŒ ì‚¬ì´íŠ¸ URL: $SITE_BASE_URL"
        echo "ğŸ”§ HTML í™•ì¥ì: $USE_HTML_EXTENSION"
        echo "ğŸ¯ ëŒ€ìƒ ì—­: ${TARGET_STATION:-'ì „ì²´'}"
        echo ""
        
        python hub.py
    
    - name: ğŸ“‹ ìƒì„± ê²°ê³¼ í™•ì¸
      run: |
        echo "ğŸ” ìƒì„±ëœ íŒŒì¼ í™•ì¸:"
        echo "ğŸ“Š ìƒì„±ëœ HTML íŒŒì¼ ê°œìˆ˜: $(find . -maxdepth 1 -name "*.html" -o -name "*ì—´ì°¨ì‹œê°„í‘œ" | wc -l)"
        echo ""
        echo "ğŸ“‹ ìƒì„±ëœ íŒŒì¼ ëª©ë¡ (ì²˜ìŒ 10ê°œ):"
        find . -maxdepth 1 -name "*.html" -o -name "*ì—´ì°¨ì‹œê°„í‘œ" | head -10
        echo ""
        echo "ğŸ“„ ë©”íƒ€ë°ì´í„° íŒŒì¼:"
        ls -la meta.json 2>/dev/null || echo "meta.json ì—†ìŒ"
        echo ""
        echo "ğŸ“‚ ë£¨íŠ¸ í´ë” ì „ì²´ í¬ê¸°:"
        du -sh . 2>/dev/null || echo "í¬ê¸° ì¸¡ì • ì‹¤íŒ¨"
    
    - name: ğŸ¨ ê¸°ë³¸ index.html ìƒì„± (ë®ì–´ì“°ê¸° ëª¨ë“œ)
      run: |
        echo "ğŸ“„ index.html ìƒì„± (ê¸°ì¡´ íŒŒì¼ ë®ì–´ì“°ê¸°)"
        cat > index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="ko">
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>ë ˆì¼ê°€ì´ë“œ - ì „êµ­ ì—´ì°¨ ì‹œê°„í‘œ</title>
          <meta name="description" content="ì „êµ­ ëª¨ë“  ì—­ì˜ KTX, SRT, ITX, ë¬´ê¶í™”í˜¸ ì—´ì°¨ ì‹œê°„í‘œë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ í™•ì¸í•˜ì„¸ìš”.">
          <style>
            body { font-family: 'Noto Sans KR', sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
            h1 { color: #2c3e50; text-align: center; }
            .station-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 30px; }
            .station-card { background: white; border: 1px solid #ddd; border-radius: 8px; padding: 15px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
            .station-card a { text-decoration: none; color: #2c3e50; font-weight: 500; }
            .station-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
          </style>
        </head>
        <body>
          <h1>ğŸš„ ë ˆì¼ê°€ì´ë“œ ì—´ì°¨ ì‹œê°„í‘œ</h1>
          <p style="text-align: center; color: #666;">ì „êµ­ ëª¨ë“  ì—­ì˜ ì—´ì°¨ ì‹œê°„í‘œë¥¼ í™•ì¸í•˜ì„¸ìš”</p>
          <div class="station-grid" id="stationList">
            <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #666;">
              ğŸ“Š ì—­ ëª©ë¡ì„ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤...
            </div>
          </div>
          <script>
            // ìƒì„±ëœ HTML íŒŒì¼ë“¤ì„ ë™ì ìœ¼ë¡œ ë¡œë“œí•´ì„œ ì—­ ëª©ë¡ ìƒì„±
            fetch('./meta.json')
              .then(response => response.json())
              .then(data => {
                const stationList = document.getElementById('stationList');
                stationList.innerHTML = '';
                
                Object.entries(data).forEach(([key, info]) => {
                  const stationCard = document.createElement('div');
                  stationCard.className = 'station-card';
                  stationCard.innerHTML = `
                    <a href="${key}">
                      <div>ğŸš‰ ${info.route.split(' â†’ ')[0]}</div>
                      <small>${info.total_destinations}ê°œ ë…¸ì„ </small>
                    </a>
                  `;
                  stationList.appendChild(stationCard);
                });
              })
              .catch(() => {
                document.getElementById('stationList').innerHTML = 
                  '<div style="grid-column: 1 / -1; text-align: center; color: #666;">ì—­ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
              });
          </script>
        </body>
        </html>
        EOF
        echo "âœ… index.html ìƒì„± ì™„ë£Œ"
    
    - name: ğŸš€ GitHub Pages ë°°í¬ (ë£¨íŠ¸ í´ë”)
      uses: peaceiris/actions-gh-pages@v3
      if: github.ref == 'refs/heads/main'
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: .
        publish_branch: gh-pages
        force_orphan: true
        enable_jekyll: false
        allow_empty_commit: false
        commit_message: 'ğŸš„ ì—´ì°¨ ì‹œê°„í‘œ ì—…ë°ì´íŠ¸: ${{ github.sha }}'
        exclude_assets: '.github,cache,hub.py,README.md,*.json,*.py'
    
    - name: ğŸ“± ë°°í¬ ì™„ë£Œ ì•Œë¦¼
      if: success()
      run: |
        REPO_NAME="${{ github.event.repository.name }}"
        OWNER="${{ github.repository_owner }}"
        
        if [ "$REPO_NAME" != "$OWNER" ]; then
          SITE_URL="https://${OWNER}.github.io/${REPO_NAME}"
        else
          SITE_URL="https://${OWNER}.github.io"
        fi
        
        echo "ğŸ‰ ë°°í¬ ì™„ë£Œ!"
        echo "ğŸŒ ì‚¬ì´íŠ¸ URL: $SITE_URL"
        echo "ğŸ“Š ìƒì„±ëœ í˜ì´ì§€ ìˆ˜: $(find docs -name "*.html" -o -name "*ì—´ì°¨ì‹œê°„í‘œ" | wc -l)"
        echo ""
        echo "â° ëª‡ ë¶„ í›„ì— ì‚¬ì´íŠ¸ì— ì ‘ì†í•´ë³´ì„¸ìš”!"
    
    - name: âŒ ì‹¤íŒ¨ ì‹œ ë””ë²„ê·¸ ì •ë³´
      if: failure()
      run: |
        echo "ğŸ” ë””ë²„ê·¸ ì •ë³´:"
        echo "ğŸ“‚ í˜„ì¬ ë””ë ‰í† ë¦¬ êµ¬ì¡°:"
        find . -type f -name "*.py" -o -name "*.json" -o -name "*.html" | head -20
        echo ""
        echo "ğŸ“„ hub.py ì¡´ì¬ ì—¬ë¶€:"
        ls -la hub.py 2>/dev/null || echo "hub.py ì—†ìŒ"
        echo ""
        echo "ğŸ“‚ cache í´ë” ìƒíƒœ:"
        ls -la cache/ 2>/dev/null || echo "cache í´ë” ì—†ìŒ"